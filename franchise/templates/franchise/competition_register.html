<!DOCTYPE html>
<html>

<head>
    <title>Register Students</title>
    <!-- Include your JavaScript and CSS libraries here -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />

    <!-- Add these lines to include Bootstrap CSS and JavaScript -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
        .navbar-link {
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            font-size: 18px;
        }

        .tabcontainer {
            padding-top: 60px;
            width: 80%;
            margin: 0 auto;
            position: relative;

        }

        .content-table {
            width: 70%;
            margin-top: 50px;
            /* Adjust the top margin as needed */
        }

        .button-column {
            color: rgb(38, 38, 244);
            font-weight: bold;
        }

        .regbtn {
            background-color: #009879;
            color: hsl(0, 0%, 100%);
            font-family: 'League Spartan', sans-serif;
            max-width: max-content;
            padding: 10px 20px;
            border-radius: 5px;

        }

        .regbtn:hover {
            background-color: #009879;
            color: hsl(0, 0%, 100%);
        }

        .regbtn:hover:active {
            background-color: #009879;
            color: hsl(0, 0%, 100%);
        }

        .content-table {
            width: 90%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            min-width: 400px;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }

        .content-table thead tr {
            background-color: #009879;
            color: #ffffff;
            text-align: left;
            font-weight: bold;
        }

        .content-table th,
        .content-table td {
            padding: 12px 15px;
        }

        .content-table tbody tr {
            border-bottom: 1px solid #dddddd;
        }

        .content-table tbody tr:nth-of-type(even) {
            background-color: #f3f3f3;
        }

        .content-table tbody tr:last-of-type {
            border-bottom: 2px solid #009879;
        }

        .content-table tbody tr.active-row {
            font-weight: bold;
            color: #009879;
        }

        .tabcontainer {
            padding-top: 60px;
            width: 80%;
            margin: 0 auto;
            position: relative;
        }

        /* Style for the select element */
        .item-select {
            width: 100%;
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            color: #333;
        }

        /* Style for the options within the select element */
        .item-select option {
            padding: 8px;
        }

        /* Style for the dropdown arrow if applicable */
        /* This might differ based on the styling method used for the dropdown arrow */
        /* Example for standard dropdown arrow */
        .item-select::after {
            content: "\25BC";
            /* Unicode for down arrow */
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* Style for the dropdown list if using select2 */
        .select2-container {
            width: 100%;
        }

        /* Additional styling for select2 if needed */
        /* You might need to adjust these styles based on your specific requirements */
        .select2-selection--single {
            height: 38px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background-color: #fff;
            color: #333;
            padding: 0 10px;
            font-size: 14px;
            line-height: 36px;
        }

        .select2-selection__arrow {
            height: 36px;
        }
    </style>

    <!-- Your HTML code with table and buttons -->

</head>

<body data-user="{{ request.user.username }}">
    <div class="tabcontainer">
        <form method="post" id="table-form">
            {% csrf_token %}

            <!-- Table -->
            <table class="content-table">
                <thead>
                    <tr>
                        <th>Students</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="expandable-row">
                        <td>
                            <select class="item-select select2" name="items[0][item]">
                                {% for student in students %}
                                <option value="{{ student.id }}">{{ student.id }} - {{ student.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><button type="button" class="btn regbtn delete-row">Delete</button></td>
                    </tr>
                </tbody>
            </table>

            <!-- Add a new row button -->
            <button type="button" id="add-row" class="btn regbtn">Add Row</button>

            <button type="submit" class="btn regbtn">Submit</button>
        </form>
    </div>

    <!-- Modal -->
    <div class="modal" id="myModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Selected Students</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <p id="selectedStudents"></p>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn" style="color: #009879;" data-dismiss="modal">Close</button>
                    <button type="button" class="btn regbtn" id="modal-submit">Submit</button>
                </div>

            </div>
        </div>
    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const urlParams = new URLSearchParams(window.location.search);
            const successMessage = urlParams.get("success_message");
    
            const currentUser = document.body.getAttribute("data-user");
    
            if (successMessage) {
                alert(successMessage);
                window.location.href = window.location.pathname;
            }
    
            document.querySelector("#table-form").addEventListener("submit", function (event) {
                event.preventDefault();
    
                const tableData = [];
                const selectedStudentNames = [];
    
                document.querySelectorAll(".expandable-row").forEach(function (row) {
                    const itemSelect = row.querySelector(".item-select");
                    const studentName = itemSelect.options[itemSelect.selectedIndex].text;
                    tableData.push({
                        item: itemSelect.value,
                    });
                    selectedStudentNames.push(studentName);
                });
    
                $('#myModal').modal('show');
                document.getElementById('selectedStudents').innerText = selectedStudentNames.join(', ');
    
                document.querySelector("#modal-submit").addEventListener("click", function () {
                    // Handle the modal submit button click
                    $('#myModal').modal('hide'); // Close the modal
    
                    // Continue with the rest of your submission logic here
                    const compId = "{{ comp_id }}";
                    const url = window.location.href;
    
                    fetch(url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken"),
                        },
                        body: JSON.stringify({
                            franchise: currentUser,
                            tableData: tableData,
                        }),
                    })
                        .then(function (response) {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(function (data) {
                            // Handle the response from the server, if needed
                            console.log(data);
    
                            // Additional actions after successful submission, if any
                        })
                        .catch(function (error) {
                            console.error('Error:', error);
                        });
                });
            });
    
            document.querySelector("#add-row").addEventListener("click", function () {
                const newRow = document.querySelector(".expandable-row").cloneNode(true);
                newRow.querySelector(".item-select").value = "";
    
                const tableBody = document.querySelector("tbody");
                tableBody.appendChild(newRow);
            });
    
            document.querySelector("tbody").addEventListener("click", function (event) {
                if (event.target.classList.contains("delete-row")) {
                    const row = event.target.parentElement.parentElement;
                    if (document.querySelectorAll(".expandable-row").length > 1) {
                        row.remove();
                    } else {
                        alert("Cannot delete the last row");
                    }
                }
            });
    
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== "") {
                    const cookies = document.cookie.split(";");
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === name + "=") {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>

</body>

</html>