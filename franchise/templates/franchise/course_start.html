<!DOCTYPE html>
<html>

<head>
    <title>Register Students</title>
    <!-- Include your JavaScript and CSS libraries here -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <style>
        .content-table {
    width: 70%;
    margin-top: 50px; /* Adjust the top margin as needed */
  }

.button-column {
    color: rgb(38, 38, 244);
    font-weight: bold;
}

.regbtn {
    background-color: #009879;
    color: hsl(0, 0%, 100%);
    font-family: 'League Spartan', sans-serif;
    max-width: max-content;
    padding: 10px 20px;
    border-radius: 5px;
  
}

.content-table {
    width: 90%;
    border-collapse: collapse;
    margin: 25px 0;
    font-size: 0.9em;
    min-width: 400px;
    border-radius: 5px 5px 0 0;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
  }
  
  .content-table thead tr {
    background-color: #009879;
    color: #ffffff;
    text-align: left;
    font-weight: bold;
  }
  
  .content-table th,
  .content-table td {
    padding: 12px 15px;
  }
  
  .content-table tbody tr {
    border-bottom: 1px solid #dddddd;
  }
  
  .content-table tbody tr:nth-of-type(even) {
    background-color: #f3f3f3;
  }
  
  .content-table tbody tr:last-of-type {
    border-bottom: 2px solid #009879;
  }
  
  .content-table tbody tr.active-row {
    font-weight: bold;
    color: #009879;
  }

.tabcontainer {
    padding-top: 60px;
    width: 80%;
    margin: 0 auto;
    position: relative;
  }
  /* Style for the label */
label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
}

/* Style for the date input field */
.datepicker {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px;
  width: 200px; /* Adjust width as needed */
}

/* Optional: Style for the date picker calendar icon if applicable */
.datepicker::after {
  content: "\1F4C5"; /* Unicode for calendar icon, you can use your preferred icon */
  font-size: 18px;
  position: absolute;
  top: 50%;
  right: 10px;
  transform: translateY(-50%);
  pointer-events: none;
}
/* Style for the select element */
.item-select {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background-color: #fff;
  color: #333;
}

/* Style for the options within the select element */
.item-select option {
  padding: 8px;
}

/* Style for the dropdown arrow if applicable */
/* This might differ based on the styling method used for the dropdown arrow */
/* Example for standard dropdown arrow */
.item-select::after {
  content: "\25BC"; /* Unicode for down arrow */
  position: absolute;
  top: 50%;
  right: 10px;
  transform: translateY(-50%);
  pointer-events: none;
}

/* Style for the dropdown list if using select2 */
.select2-container {
  width: 100%;
}

/* Additional styling for select2 if needed */
/* You might need to adjust these styles based on your specific requirements */
.select2-selection--single {
  height: 38px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background-color: #fff;
  color: #333;
  padding: 0 10px;
  font-size: 14px;
  line-height: 36px;
}

.select2-selection__arrow {
  height: 36px;
}


    </style>
</head>

<body data-user="{{ request.user.username }}">
    <form method="post" id="table-form">

        <label for="course_start_date">Course Start Date:</label>
        <input type="text" id="course_start_date" class="datepicker" name="course_start_date" required>

        <!-- Table -->
        <table class="content-table">
            <thead>
                <tr>
                    <th>Students</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <tr class="expandable-row">
                    <td>
                        <select class="item-select select2" name="items[0][item]">
                            {% for student in students %}
                            <option value="{{ student.id }}">{{ student.id }} - {{ student.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><button type="button" class="regbtn delete-row">Delete</button></td>
                </tr>
            </tbody>
        </table>

        <!-- Add a new row button -->
        <button type="button" id="add-row" class="regbtn">Add Row</button>

        <button type="submit" class="regbtn">Submit</button>
    </form>

    <script>
        $('#course_start_date').datepicker({
            dateFormat: 'yy-mm-dd',  // Set the desired date format
            changeYear: true,
            changeMonth: true,
            yearRange: "-100:+0"  // Allow selecting from the past 100 years to the current year
        });
        const urlParams = new URLSearchParams(window.location.search);
        const successMessage = urlParams.get("success_message");

        if (successMessage) {
            // Display an alert with the success message
            alert(successMessage);

            // Reload the page to clear the success message from the URL
            window.location.href = window.location.pathname;
        }



        // Handle adding a new row
        document.querySelector("#add-row").addEventListener("click", () => {
            const newRow = document
                .querySelector(".expandable-row")
                .cloneNode(true);
            newRow.querySelector(".item-select").value = "";

            const tableBody = document.querySelector("tbody");
            tableBody.appendChild(newRow);
        });

        // Handle deleting a row
        document.querySelector("tbody").addEventListener("click", (event) => {
            if (event.target.classList.contains("delete-row")) {
                const row = event.target.parentElement.parentElement;
                if (document.querySelectorAll(".expandable-row").length > 1) {
                    row.remove();
                } else {
                    alert("Cannot delete the last row");
                }
            }
        });

        var currentUser = document.body.getAttribute("data-user");


        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(
                            cookie.substring(name.length + 1)
                        );
                        break;
                    }
                }
            }
            console.log(cookieValue);
            return cookieValue;
        }

        document
            .querySelector("#table-form")
            .addEventListener("submit", (event) => {
                event.preventDefault();

                const tableData = [];
                const courseStartDate = $("#course_start_date").val();
                console.log(courseStartDate);

                document.querySelectorAll(".expandable-row").forEach((row) => {
                    const itemSelect = row.querySelector(".item-select");
                    tableData.push({
                        item: itemSelect.value,
                    });
                });

                console.log(tableData)

                const url = window.location.href;

                // Send the data to the server
                fetch(url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken"), // Include CSRF token
                    },
                    body: JSON.stringify({
                        tableData: tableData,
                        course_start_date: courseStartDate,
                    }),
                })


                    .then((response) => response.json())
                    .then((data) => {
                        // Handle the response from the server, if needed
                        console.log(data);
                    });

            });
    </script>
</body>

</html>